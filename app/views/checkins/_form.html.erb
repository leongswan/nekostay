<%= form_with model: [@stay, checkin], class: "card" do |f| %>
  <%# この partial は render "form", checkin: @checkin で呼ばれている前提 %>
  <%# f.object と checkin は同じものですが、下で checkin.* を使うために残しています %>

  <h2 style="margin-top:0;">チェックイン</h2>

  <div class="form-grid">
    <div>
      <%= f.label :checked_at, "記録日時" %>
      <%= f.datetime_local_field :checked_at,
            value: (checkin.checked_at&.strftime("%Y-%m-%dT%H:%M") || Time.zone.now.strftime("%Y-%m-%dT%H:%M")),
            class: "input" %>
    </div>

    <div>
      <%= f.label :weight, "体重(kg)" %>
      <%= f.number_field :weight, step: "0.01", class: "input" %>
    </div>
  </div>

  <div style="margin-top:12px;">
    <%= f.label :memo, "メモ" %>
    <%= f.text_area :memo, rows: 4, class: "textarea" %>
  </div>

  <hr>

  <% meal = checkin.meal || {} %>
  <h3>Meal</h3>
  <div class="form-grid">
    <div>
      <%= f.label :meal_amount, "量" %>
      <%= f.text_field :meal_amount, value: meal["amount"], class: "input" %>
    </div>
    <div>
      <%= f.label :meal_brand, "フード名" %>
      <%= f.text_field :meal_brand, value: meal["brand"], class: "input" %>
    </div>
  </div>

  <hr>

  <% lt = checkin.litter || {} %>
  <h3>Litter</h3>
  <div class="form-grid">
    <div>
      <%= f.label :litter_clumps, "固まり数" %>
      <%= f.number_field :litter_clumps, value: lt["clumps"], class: "input", min: 0 %>
    </div>
    <div>
      <%= f.label :litter_pee, "おしっこ回数" %>
      <%= f.number_field :litter_pee, value: lt["pee"], class: "input", min: 0 %>
    </div>
  </div>

  <hr>

  <% md = checkin.meds || {} %>
  <h3>Meds</h3>
  <div class="form-grid">
    <div>
      <%= f.label :meds_name, "薬剤名" %>
      <%= f.text_field :meds_name, value: md["name"], class: "input" %>
    </div>
    <div>
      <%= f.label :meds_dose, "投与量" %>
      <%= f.text_field :meds_dose, value: md["dose"], class: "input" %>
    </div>
  </div>

  <div class="form-grid" style="margin-top:8px;">
    <label class="checkbox">
      <%= f.check_box :meds_given,  { checked: !!md["given"],  class: "exclusive-med" }, "true", "false" %> 投与済
    </label>
    <label class="checkbox">
      <%= f.check_box :meds_none,   { checked: !!md["none"],   class: "exclusive-med" }, "true", "false" %> 投与なし
    </label>
    <label class="checkbox">
      <%= f.check_box :vaccine_3rd, { checked: !!md["vaccine_3rd"] }, "true", "false" %> ワクチン3回目済
    </label>
  </div>

  <div class="stack" style="margin-top:16px;">
    <%= link_to "キャンセル", stay_checkins_path(@stay), data: { turbo_frame: "_self" }, class: "btn" %>
    <%= f.submit (checkin.persisted? ? "更新する" : "保存する"), class: "btn btn--primary" %>
  </div>
<% end %>

<!-- 相互排他＆入力無効化のちょい足しJS（Stimulusなしの素朴版） -->
<script>
(function() {
  function ready(fn){ 
    if (document.readyState !== 'loading') fn();
    document.addEventListener('DOMContentLoaded', fn);
    document.addEventListener('turbo:load', fn); // Turbo対応
  }

  ready(function(){
    var given = document.getElementById('checkin_meds_given');
    var none  = document.getElementById('checkin_meds_none');
    var name  = document.getElementById('checkin_meds_name');
    var dose  = document.getElementById('checkin_meds_dose');

    if (!given || !none) return;

    function sync() {
      // 排他：どちらかONならもう一方はOFF
      if (given.checked) none.checked = false;
      if (none.checked)  given.checked = false;

      // 「投与なし」がONの間は、名前/量/投与済を無効化
      var disableDetail = none.checked;
      given.disabled = disableDetail;
      name.disabled  = disableDetail;
      dose.disabled  = disableDetail;

      if (disableDetail) {
        // UI的にも値を空にしておくと分かりやすい（任意）
        // name.value = '';
        // dose.value = '';
      }
    }

    given.addEventListener('change', sync);
    none.addEventListener('change',  sync);
    sync(); // 初期同期
  });
})();
</script>

