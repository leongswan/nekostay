<%# 
  app/views/stays/show.html.erb
  Handoff „Å∏„ÅÆ„É™„É≥„ÇØ„ÇíËøΩÂä†„Åó„ÄÅUI„Çí .card „Å® .stack „Å´Áµ±‰∏Ä
%>

<h1><%= t(".title", id: @stay.id) %></h1>

<div class="card" style="margin-bottom:16px;">
  <div class="form-grid">
    <p><span class="meta"><%= t(".pet") %></span><br><%= @stay.pet&.name || "-" %></p>
    <p><span class="meta"><%= t(".place") %></span><br><%= @stay.place %></p>
    <p><span class="meta"><%= t(".period") %></span><br><%= @stay.start_on %> „Äú <%= @stay.end_on %></p>
    <p><span class="meta"><%= t(".status") %></span><br><%= status_badge(@stay) %></p>
  </div>

  <% if @stay.notes.present? %>
    <hr> <p class="meta"><%= t(".notes") %></p>
    <p style="margin:0;"><%= simple_format(@stay.notes) %></p>
  </div>
  <% end %>
</div>


<%# Â≠êÂàÜÂâ≤„ÅÆ‰∏ÄË¶ßÔºà„ÅÇ„ÇãÂ†¥ÂêàÔºâ %>
<% if @stay.children.exists? %>
  <div class="card" style="margin-bottom:16px;">
    <h3 style="margin-top:0;"><%= t(".children_title", count: @stay.children.count) %></h3>
    
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>ÊúüÈñì</th>
          <th>„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥</th>
          <th>ÂºïÁ∂ô„Åé (Handoff)</th>
        </tr>
      </thead>
      <tbody>
        <%# 
          Â≠ê„Çπ„ÉÜ„Ç§„Çí„É´„Éº„ÉóÂá¶ÁêÜ
          .with_attached_handoffs „ÅÆ„Çà„ÅÜ„Å™N+1ÂØæÁ≠ñ„Çπ„Ç≥„Éº„Éó„Åå„É¢„Éá„É´„Å´„ÅÇ„Çã„Å®Â∞öËâØ„ÅÑ
        %>
        <% @stay.children.order(:start_on).each do |child| %>
          <tr>
            <td>#<%= child.id %></td>
            <td class="nowrap"><%= child.start_on %> „Äú <%= child.end_on %></td>
            <td>
              <%= link_to t(".action.checkins"), 
                          stay_checkins_path(child), 
                          class: "btn" %>
            </td>
            <td>
              <%# 
                üîπ ËøΩÂä†Ôºö
                „Åì„ÅÆ„Çπ„ÉÜ„Ç§„Åå„ÄåÂºïÁ∂ô„ÅéÂÖà (to_stay)„Äç„Å®„Å™„Å£„Å¶„ÅÑ„Çã Handoff „ÇíÊé¢„Åô
                (‰æã: Stay B „ÅØ„ÄÅStay A -> Stay B „ÅÆ Handoff „ÇíÊåÅ„Å§)
              %>
              <% handoff = child.incoming_handoff %>
              <% if handoff %>
                <%= link_to edit_handoff_path(handoff), class: "btn" do %>
                  <%# Handoff „ÅåÂÆå‰∫ÜÊ∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØ %>
                  <% if handoff.completed_at? %>
                    <span style="color: green;">‚úî</span> ÂÆå‰∫Ü
                  <% else %>
                    <span style="color: red;">!</span> „É°„É¢Á∑®ÈõÜ
                  <% end %>
                <% end %>
              <% else %>
                <span class="meta">---</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

  </div>
<% end %>

<%# „É°„ÉÉ„Çª„Éº„Ç∏„Å∏„ÅÆ„É™„É≥„ÇØ %>
<div class="card mb-4" style="background-color: #f0f8ff; border-color: #bee3f8;">
  <div class="stack stack--between">
    <div>
      <h3 style="margin:0; color: #2b6cb0;">„É°„ÉÉ„Çª„Éº„Ç∏</h3>
      <p class="meta" style="margin: 4px 0 0;">„Ç∑„ÉÉ„Çø„Éº„Å®„ÉÅ„É£„ÉÉ„Éà„ÅßÈÄ£Áµ°„ÇíÂèñ„Çã</p>
    </div>
    <%= link_to "„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË¶ã„Çã", stay_messages_path(@stay), class: "btn btn--primary" %>
  </div>
</div>


<%# ÊúÄËøë„ÅÆ Checkins %>
<div class="card"> <div class="stack stack--end" style="width:100%; margin-bottom:12px;">
    
    <h3 style="margin:0; margin-right: auto;"><%= t(".recent_checkins") %></h3>

    <%= link_to "ÂºïÁ∂ô„Åé‰∏ÄË¶ß", handoffs_path, class: "btn btn--ghost" %>
    
    <%= link_to t(".action.to_index"), stay_checkins_path(@stay), class: "btn" %>
    <%= link_to t(".action.new_checkin"), new_stay_checkin_path(@stay), class: "btn btn--primary" %>
  </div>

  <% if @recent_checkins.blank? %>
    <p class="meta"><%= t(".no_checkins") %></p>
  <% else %>
    <table class="table"> <thead>
        <tr>
          <th><%= t(".table.time") %></th>
          <th><%= t(".table.weight") %></th>
          <th><%= t(".table.meal") %></th>
          <th><%= t(".table.litter") %></th>
          <th><%= t(".table.meds") %></th>
          <th><%= t(".table.memo") %></th>
          <th style="width:120px;"><%= t(".table.actions") %></th>
        </tr>
      </thead>
      <tbody>
        <% @recent_checkins.each do |c| %>
          <tr>
            <td class="nowrap"><%= link_to dt_label(c.checked_at), stay_checkins_path(@stay, c) %></td>
            <td class="col-right"><%= weight_label(c.weight) %></td>
            <td><%= meal_label(c.meal) %></td>
            <td><%= litter_label(c.litter) %></td>
            <td><%= meds_badges(c.meds) %></td>
            <td class="truncate"><%= simple_format(c.memo) %></td>
            <td>
              <div class="stack">
                <%= link_to t(".action.show"), stay_checkin_path(@stay, c), class: "btn btn--ghost" %>
                <%= link_to t(".action.edit"), edit_stay_checkin_path(@stay, c), class: "btn" %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>
</div>

<turbo-frame id="modal"></turbo-frame>