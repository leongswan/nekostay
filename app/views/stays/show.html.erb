<div style="max-width: 800px; margin: 0 auto; padding: 20px;">
  
  <% if notice %>
    <div style="background: #e6fffa; color: #00b894; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #b2f5ea;">
      <%= notice %>
    </div>
  <% end %>

  <div style="margin-bottom: 20px;">
    <%= link_to stays_path, style: "text-decoration: none; color: #999; display: inline-flex; align-items: center; gap: 5px;" do %>
      <i class="fa-solid fa-arrow-left"></i> ダッシュボードへ
    <% end %>
  </div>

  <div style="background: white; border-radius: 16px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 30px; display: flex; align-items: center; gap: 30px;">
    <div style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; border: 4px solid #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); flex-shrink: 0; background: #eee;">
      <% if @stay.pet&.image&.attached? %>
        <%= image_tag @stay.pet.image, style: "width: 100%; height: 100%; object-fit: cover;" %>
      <% else %>
        <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:40px;">🐱</div>
      <% end %>
    </div>
    
    <div style="flex-grow: 1;">
      <h1 style="margin: 0 0 10px 0; color: #5A4A42; font-size: 1.5rem;">
        <%= @stay.pet&.name %>ちゃんのお留守番
      </h1>
      <div style="color: #888; margin-bottom: 15px;">
        <i class="fa-regular fa-calendar"></i> 
        <%= @stay.start_on.strftime('%Y年%m月%d日') %> 〜 <%= @stay.end_on.strftime('%m月%d日') %>
      </div>

      <div style="display: flex; gap: 20px; font-size: 0.9rem; color: #666;">
        <div>
          <span style="color: #D98E63; font-weight: bold;">📍 お世話する場所</span><br>
          <%= @stay.place == 'sitter_home' ? 'シッターの自宅' : '飼い主の自宅' %>
        </div>
        <div>
          <span style="color: #D98E63; font-weight: bold;">📝 シッターへのメモ</span><br>
          <%= @stay.notes.presence || '特になし' %>
        </div>
      </div>
    </div>

    <div style="display: flex; flex-direction: column; gap: 10px;">
      <%= link_to edit_stay_path(@stay), style: "text-decoration: none; color: #D98E63; border: 1px solid #D98E63; padding: 8px 20px; border-radius: 8px; text-align: center; font-weight: bold;" do %>
        <i class="fa-solid fa-pen"></i> 編集
      <% end %>
      
      <%= button_to stay_path(@stay), method: :delete, data: { confirm: "本当に削除しますか？" }, style: "background: none; border: none; color: #999; cursor: pointer; text-decoration: underline; font-size: 0.8rem;" do %>
        <i class="fa-solid fa-trash"></i> 削除
      <% end %>
    </div>
  </div>

  <div style="margin-bottom: 30px; text-align: center;">
    <%= link_to handoffs_path, style: "display: inline-block; background: white; border: 2px solid #D98E63; color: #D98E63; padding: 12px 40px; border-radius: 30px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 10px rgba(217, 142, 99, 0.2);" do %>
      <i class="fa-solid fa-key"></i> このお留守番の引継ぎリストを確認する
    <% end %>
  </div>

  <% if Date.current > @stay.end_on && @stay.review.nil? && current_user == @stay.owner %>
    <div style="margin-bottom: 30px; text-align: center;">
      <div style="background: #fff8f0; border: 2px dashed #D98E63; padding: 20px; border-radius: 16px;">
        <h3 style="color: #D98E63; margin: 0 0 10px 0;">お世話は無事に終わりましたか？</h3>
        <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">シッターさんへの感謝の気持ちや、評価を送りましょう！</p>
        <%= link_to new_stay_review_path(@stay), style: "display: inline-block; background: #D98E63; color: white; padding: 12px 30px; border-radius: 30px; text-decoration: none; font-weight: bold;" do %>
          <i class="fa-regular fa-star"></i> レビューを書く
        <% end %>
      </div>
    </div>
  <% elsif @stay.review.present? %>
    <div style="margin-bottom: 30px; text-align: center; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative;">
      
      <div style="color: #D98E63; font-size: 1.5rem; letter-spacing: 5px; margin-bottom: 10px;">
        <%= "★" * @stay.review.score %><%= "☆" * (5 - @stay.review.score) %>
      </div>

      <div style="color: #555; font-size: 1rem; line-height: 1.6; margin-bottom: 10px;">
        <% if @stay.review.comment.present? %>
          「<%= @stay.review.comment %>」
        <% else %>
          <span style="color: #ccc; font-size: 0.8rem;">(コメントなし)</span>
        <% end %>
      </div>

      <div style="font-size: 0.8rem; color: #999;">
        投稿日: <%= @stay.review.created_at.strftime('%Y/%m/%d') %>
      </div>

      <% if current_user == @stay.owner %>
        <%= button_to stay_review_path(@stay, @stay.review), method: :delete, style: "position: absolute; top: 15px; right: 15px; background: none; border: none; color: #ccc; cursor: pointer;", data: { confirm: "レビューを削除して書き直しますか？" } do %>
          <i class="fa-solid fa-trash"></i>
        <% end %>
      <% end %>

    </div>
  <% end %>

  <div style="margin-bottom: 20px; border-left: 5px solid #D98E63; padding-left: 15px;">
    <h3 style="margin: 0; color: #5A4A42;">🗓 お世話のスケジュール & 日報</h3>
  </div>

  <div style="display: grid; gap: 15px;">
    <% (@stay.start_on..@stay.end_on).each do |date| %>
      <% checkin = @stay.checkins.find_by(checked_at: date.all_day) %>
      
      <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee; display: flex; align-items: center; justify-content: space-between;">
        
        <div style="text-align: center; min-width: 60px;">
          <div style="font-size: 0.8rem; color: #999;"><%= date.strftime('%m/%d') %></div>
          <div style="font-weight: bold; font-size: 1.2rem; color: #5A4A42;"><%= date.strftime('%a') %></div>
        </div>

        <div style="flex-grow: 1; padding: 0 20px;">
          <% if checkin %>
            <div style="color: #5A4A42; font-weight: bold; margin-bottom: 5px;">お世話レポート</div>
            <div style="font-size: 0.9rem; color: #666;">
              <%# ↓↓↓ 文言を修正しました！ ↓↓↓ %>
              <%= truncate(checkin.report, length: 30) || "📸 写真による報告" %>
            </div>
          <% else %>
            <div style="color: #ccc;">まだ報告はありません</div>
          <% end %>
        </div>

        <% if checkin %>
          <%= link_to "報告を見る", stay_checkin_path(@stay, checkin), style: "background: #D98E63; color: white; text-decoration: none; padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 0.9rem;" %>
        <% else %>
          <% if current_user.id == @stay.sitter_id %>
            <%= link_to "📝 報告する", new_stay_checkin_path(@stay), style: "background: #D98E63; color: white; text-decoration: none; padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 0.9rem;" %>
          <% else %>
            <span style="color: #ccc; font-size: 0.9rem;">報告待ち</span>
          <% end %>
        <% end %>

      </div>
    <% end %>
  </div>

  <div style="margin-top: 50px; background: #f0f4f8; padding: 20px; border-radius: 16px;">
    <h3 style="color: #5A4A42; margin-top: 0;">
      <i class="fa-regular fa-comments"></i> 連絡ノート
    </h3>
    
    <div id="messages" style="height: 300px; overflow-y: auto; background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #ddd;">
      </div>

    <%= form_with(model: Message.new, url: messages_path, local: true, data: { controller: "reset-form", action: "turbo:submit-end->reset-form#reset" }) do |f| %>
      <%= f.hidden_field :stay_id, value: @stay.id %>
      
      <div style="margin-bottom: 10px;">
        <%= f.text_area :body, rows: 3, placeholder: "メッセージを入力してください...", style: "width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #ccc; box-sizing: border-box;" %>
      </div>
      
      <div style="text-align: right;">
        <%= button_tag type: "submit", style: "background: #5A4A42; color: white; border: none; padding: 10px 30px; border-radius: 30px; font-weight: bold; cursor: pointer;" do %>
          <i class="fa-solid fa-paper-plane"></i> 送信する
        <% end %>
      </div>
    <% end %>
  </div>

</div>